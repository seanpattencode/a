<!DOCTYPE html>
<html><head><title>Terminal Emulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{{margin:0;padding:0;box-sizing:border-box}}
body{{background:#000;font:14px monospace;color:#dfdbd2;padding:20px;margin:0;overflow:hidden;height:100vh;box-sizing:border-box}}
#add-terminal{{padding:10px 20px;background:#333;border:1px solid #555;color:#dfdbd2;cursor:pointer;margin-bottom:10px;border-radius:5px;display:block;width:fit-content}}
#terminals-container{{height:calc(100vh - 70px);overflow-y:auto}}
.terminal-box{{background:#111;border:1px solid #333;border-radius:10px;padding:5px;margin-bottom:10px;overflow:hidden;display:flex;flex-direction:column}}
#term{{flex:1;overflow-x:auto;overflow-y:auto;min-height:0}}
.cmd-bar{{padding:5px;border-top:1px solid #333;flex-shrink:0;background:#111}}
.line{{white-space:pre-wrap;word-wrap:break-word;user-select:text}}
#prompt-line{{white-space:pre;padding-left:12px;position:relative}}
#prompt-line:before{{content:'$ ';position:absolute;left:0;top:0}}
#input{{background:transparent;border:none;color:#dfdbd2;font:14px monospace;outline:none;width:100%;padding:0}}
</style></head><body>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
  <input type="text" id="terminal-dir" placeholder="Directory path (optional)" value="." style="width:300px;padding:10px;background:#222;border:1px solid #444;color:#dfdbd2;border-radius:5px"/>
  <button id="add-terminal" onclick="addTerminalWithDir()">+ Add Terminal</button>
</div>
<div id="terminals-container">
<div class="terminal-box">
  <div id="term">
    <div id="prompt-line"><input id="input" type="text" autocomplete="off" spellcheck="false"/></div>
  </div>
  <div class="cmd-bar">
    <button onclick="removeStaticTerminal('term')" style="padding:5px 10px;background:#d32;border:1px solid #a21;color:#fff;cursor:pointer;margin-right:10px;font-weight:bold">✕</button>
    <select id="term-preset" style="padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-right:5px">
      <option value="">Quick Commands</option>
      <option value="claude --dangerously-skip-permissions">Claude</option>
      <option value='codex -c model_reasoning_effort="high" --model gpt-5-codex --dangerously-bypass-approvals-and-sandbox'>Codex</option>
    </select>
    <button onclick="usePreset('term')" style="padding:5px 10px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer">Use</button>
    <input id="term-cmd" type="text" style="width:calc(100% - 420px);padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-left:5px" placeholder="Enter command..." onkeydown="if(event.key==='Enter')sendTermCmd()"/>
    <button onclick="sendTermCmd()" style="padding:5px 15px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer;margin-left:5px">Send</button>
  </div>
</div>
<div class="terminal-box">
  <div style="flex:1;min-height:0;overflow:hidden">
    <div id="xterm" style="width:100%;height:100%"></div>
  </div>
  <div class="cmd-bar">
    <button onclick="removeStaticTerminal('xterm')" style="padding:5px 10px;background:#d32;border:1px solid #a21;color:#fff;cursor:pointer;margin-right:10px;font-weight:bold">✕</button>
    <select id="xterm-preset" style="padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-right:5px">
      <option value="">Quick Commands</option>
      <option value="claude --dangerously-skip-permissions">Claude</option>
      <option value='codex -c model_reasoning_effort="high" --model gpt-5-codex --dangerously-bypass-approvals-and-sandbox'>Codex</option>
    </select>
    <button onclick="usePreset('xterm')" style="padding:5px 10px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer">Use</button>
    <input id="xterm-cmd" type="text" style="width:calc(100% - 420px);padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-left:5px" placeholder="Enter command..." onkeydown="if(event.key==='Enter')sendXtermCmd()"/>
    <button onclick="sendXtermCmd()" style="padding:5px 15px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer;margin-left:5px">Send</button>
  </div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css"/>
<script>
const term = document.getElementById('term');
const promptLine = document.getElementById('prompt-line');
const input = document.getElementById('input');
const ws = new WebSocket('ws://localhost:8766');
ws.binaryType = 'arraybuffer';
let history = [];
let historyIndex = -1;
let ignoreNext = false;
let currentCols = 80;
let currentRows = 24;

const ansiRegex = /\x1b\[[^\x1b]*?[a-zA-Z]/g;
const controlRegex = /[\x00-\x1F\x7F]/g;

const byteToChar = new Array(256);
for(let i=0;i<256;i++)byteToChar[i]=String.fromCharCode(i);

function calculateSize() {{
  const cols = Math.floor((window.innerWidth - 20) / 8.4);
  const rows = Math.floor((window.innerHeight - 20) / 16.8);
  currentCols = cols;
  currentRows = rows;
}}

ws.onopen = () => {{
  calculateSize();
  const msg = JSON.stringify({{resize:{{rows:currentRows,cols:currentCols}},term:'xterm-256color'}});
  const bytes = new Uint8Array(msg.length);
  for(let i=0;i<msg.length;i++)bytes[i]=msg.charCodeAt(i);
  ws.send(bytes);
}};

ws.onmessage = e => {{
  const bytes = new Uint8Array(e.data);
  let str = '';
  for(let i=0;i<bytes.length;i++)str+=byteToChar[bytes[i]];

  if(ignoreNext && str.includes(input.value)){{ignoreNext=false;return;}}

  const clean = str.replace(ansiRegex,'').replace(controlRegex,c=>c==='\n'?'\n':'');

  let start = 0;
  for(let i=0;i<clean.length;i++){{
    if(clean[i]==='\n'){{
      const line = document.createElement('div');
      line.className = 'line';
      line.textContent = clean.substring(start,i);
      term.insertBefore(line,promptLine);
      start = i+1;
    }}
  }}
  if(start<clean.length){{
    const line = document.createElement('div');
    line.className = 'line';
    line.textContent = clean.substring(start);
    term.insertBefore(line,promptLine);
  }}

  promptLine.scrollIntoView();
}};

input.onkeydown = e => {{
  const k = e.key;
  let data = null;

  // Only handle if input is focused
  if(document.activeElement !== input) return;

  if(e.ctrlKey){{
    const key = k.toLowerCase();
    if(key==='c'){{data='\x03';input.value='';e.preventDefault();}}
    else if(key==='d'){{data='\x04';e.preventDefault();}}
    else if(key==='l'){{term.innerHTML='';term.appendChild(promptLine);data='\x0c';e.preventDefault();}}
  }}else{{
    if(k==='Enter'){{
      const cmd = input.value;
      if(cmd){{history.push(cmd);historyIndex=history.length;}}

      calculateSize();
      const resizeMsg = JSON.stringify({{resize:{{rows:currentRows,cols:currentCols}}}});
      const resizeBytes = new Uint8Array(resizeMsg.length);
      for(let i=0;i<resizeMsg.length;i++)resizeBytes[i]=resizeMsg.charCodeAt(i);
      ws.send(resizeBytes);

      data = cmd+'\r';
      ignoreNext=true;
      input.value='';
      e.preventDefault();
    }}else if(k==='ArrowUp'){{
      if(historyIndex>0){{historyIndex--;input.value=history[historyIndex];}}
      e.preventDefault();
    }}else if(k==='ArrowDown'){{
      if(historyIndex<history.length-1){{historyIndex++;input.value=history[historyIndex];}}
      else{{historyIndex=history.length;input.value='';}}
      e.preventDefault();
    }}else if(k==='Tab'){{data='\t';e.preventDefault();}}
  }}

  if(data){{
    const bytes = new Uint8Array(data.length);
    for(let i=0;i<data.length;i++)bytes[i]=data.charCodeAt(i);
    ws.send(bytes);
  }}
}};

term.onclick = e => {{
  if(e.target !== input) input.blur();
}};

// Terminal management
let terminalCount = 2;
const terminals = [];

// Add terminal with directory
function addTerminalWithDir() {{
  const dirPath = document.getElementById('terminal-dir').value || '.';
  addTerminal(dirPath);
}}

// Handle Enter key in directory input
document.addEventListener('DOMContentLoaded', () => {{
  const dirInput = document.getElementById('terminal-dir');
  if(dirInput) {{
    dirInput.addEventListener('keydown', (e) => {{
      if(e.key === 'Enter') {{
        addTerminalWithDir();
      }}
    }});
  }}
}});

function updateTerminalSizes() {{
  const container = document.getElementById('terminals-container');
  const boxes = document.querySelectorAll('.terminal-box');
  const count = boxes.length;

  const minHeight = 200;
  const buttonHeight = 50;
  const containerPadding = 40;
  const boxMargin = 10;
  const totalMargins = (count - 1) * boxMargin;
  const availableHeight = window.innerHeight - buttonHeight - containerPadding;
  const calculatedHeight = Math.max(minHeight, Math.floor((availableHeight - totalMargins) / count));

  let i = 0;
  while(i < boxes.length) {{
    boxes[i].style.height = calculatedHeight + 'px';
    i++;
  }}
}}

function removeStaticTerminal(termType) {{
  if(termType === 'xterm') {{
    if(xtermWs) xtermWs.close();
    if(mainXterm) mainXterm.dispose();
  }} else if(termType === 'term') {{
    if(ws) ws.close();
  }}

  const termElement = document.getElementById(termType);
  if(termElement && termElement.parentElement) {{
    let parent = termElement.parentElement;
    while(parent && !parent.classList.contains('terminal-box')) {{
      parent = parent.parentElement;
    }}
    if(parent) parent.remove();
  }}

  updateTerminalSizes();
}}

function removeTerminal(termId) {{
  const termIndex = terminals.findIndex(t => t.id === termId);
  if(termIndex !== -1) {{
    terminals[termIndex].ws.close();
    terminals.splice(termIndex, 1);
  }}

  const termDiv = document.getElementById(termId);
  if(termDiv && termDiv.parentElement && termDiv.parentElement.parentElement) {{
    termDiv.parentElement.parentElement.remove();
  }}

  updateTerminalSizes();
}}

function addTerminal(startDir) {{
  terminalCount++;
  const container = document.getElementById('terminals-container');
  const termId = 'xterm-' + terminalCount;
  const cmdId = 'cmd-' + terminalCount;
  const presetId = 'preset-' + terminalCount;
  const directory = startDir || '.';

  const termBox = document.createElement('div');
  termBox.className = 'terminal-box';

  const wrapper = document.createElement('div');
  wrapper.style.cssText = 'flex:1;min-height:0;overflow:hidden;position:relative';

  const dirLabel = document.createElement('div');
  dirLabel.style.cssText = 'position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.7);color:#888;padding:2px 8px;font-size:12px;border-radius:3px;z-index:10';
  dirLabel.textContent = 'Dir: ' + directory;
  wrapper.appendChild(dirLabel);

  const termDiv = document.createElement('div');
  termDiv.id = termId;
  termDiv.style.cssText = 'width:100%;height:100%';
  wrapper.appendChild(termDiv);

  const cmdBar = document.createElement('div');
  cmdBar.className = 'cmd-bar';

  const removeBtn = document.createElement('button');
  removeBtn.textContent = '✕';
  removeBtn.style.cssText = 'padding:5px 10px;background:#d32;border:1px solid #a21;color:#fff;cursor:pointer;margin-right:10px;font-weight:bold';
  removeBtn.onclick = () => removeTerminal(termId);

  const select = document.createElement('select');
  select.id = presetId;
  select.style.cssText = 'padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-right:5px';
  select.innerHTML = '<option value="">Quick Commands</option><option value="claude --dangerously-skip-permissions">Claude</option><option value=\'codex -c model_reasoning_effort="high" --model gpt-5-codex --dangerously-bypass-approvals-and-sandbox\'>Codex</option>';

  const useBtn = document.createElement('button');
  useBtn.textContent = 'Use';
  useBtn.style.cssText = 'padding:5px 10px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer';
  useBtn.onclick = () => usePresetDynamic(termId, presetId, cmdId);

  const input = document.createElement('input');
  input.id = cmdId;
  input.type = 'text';
  input.style.cssText = 'width:calc(100% - 420px);padding:5px;background:#222;border:1px solid #444;color:#dfdbd2;margin-left:5px';
  input.placeholder = 'Enter command...';
  input.onkeydown = (e) => {{ if(e.key === 'Enter') sendDynamicCmd(termId, cmdId); }};

  const sendBtn = document.createElement('button');
  sendBtn.textContent = 'Send';
  sendBtn.style.cssText = 'padding:5px 15px;background:#333;border:1px solid #444;color:#dfdbd2;cursor:pointer;margin-left:5px';
  sendBtn.onclick = () => sendDynamicCmd(termId, cmdId);

  cmdBar.appendChild(removeBtn);
  cmdBar.appendChild(select);
  cmdBar.appendChild(useBtn);
  cmdBar.appendChild(input);
  cmdBar.appendChild(sendBtn);

  termBox.appendChild(wrapper);
  termBox.appendChild(cmdBar);
  container.appendChild(termBox);

  setTimeout(() => {{
    const xterm = new Terminal();
    const xtermFit = new FitAddon.FitAddon();
    xterm.loadAddon(xtermFit);
    xterm.open(document.getElementById(termId));
    xtermFit.fit();
    const xtermWs = new WebSocket('ws://localhost:8766');
    xtermWs.binaryType = 'arraybuffer';
    xtermWs.onmessage = e => xterm.write(new Uint8Array(e.data));
    xterm.onData(d => xtermWs.send(new TextEncoder().encode(d)));

    terminals.push({{ id: termId, term: xterm, fit: xtermFit, ws: xtermWs }});

    updateTerminalSizes();
    xtermFit.fit();

    // Send cd command to change to specified directory
    if(directory && directory !== '.') {{
      setTimeout(() => {{
        xtermWs.send(new TextEncoder().encode('cd ' + directory + '\r'));
      }}, 200);
    }}
  }}, 100);
}}

function usePresetDynamic(termId, presetId, cmdId) {{
  const select = document.getElementById(presetId);
  const cmd = select.value;
  if(cmd) {{
    document.getElementById(cmdId).value = cmd;
    select.selectedIndex = 0;
  }}
}}

function sendDynamicCmd(termId, cmdId) {{
  const cmd = document.getElementById(cmdId).value;
  if(cmd) {{
    const terminal = terminals.find(t => t.id === termId);
    if(terminal) {{
      terminal.ws.send(new TextEncoder().encode(cmd + '\r'));
      document.getElementById(cmdId).value = '';
    }}
  }}
}}

// Command send functions
function usePreset(termType) {{
  const select = document.getElementById(termType + '-preset');
  const cmd = select.value;
  if(cmd) {{
    document.getElementById(termType + '-cmd').value = cmd;
    select.selectedIndex = 0;
  }}
}}

function sendTermCmd() {{
  const cmd = document.getElementById('term-cmd').value;
  if(cmd) {{
    const data = cmd + '\r';
    const bytes = new Uint8Array(data.length);
    for(let i=0;i<data.length;i++)bytes[i]=data.charCodeAt(i);
    ws.send(bytes);
    document.getElementById('term-cmd').value = '';
  }}
}}

function sendXtermCmd() {{
  const cmd = document.getElementById('xterm-cmd').value;
  if(cmd) {{
    xtermWs.send(new TextEncoder().encode(cmd + '\r'));
    document.getElementById('xterm-cmd').value = '';
  }}
}}

// XTerm setup
let xtermWs;
let mainXterm;
let mainXtermFit;
setTimeout(() => {{
  mainXterm = new Terminal();
  mainXtermFit = new FitAddon.FitAddon();
  mainXterm.loadAddon(mainXtermFit);
  mainXterm.open(document.getElementById('xterm'));
  mainXtermFit.fit();
  xtermWs = new WebSocket('ws://localhost:8766');
  xtermWs.binaryType = 'arraybuffer';
  xtermWs.onmessage = e => mainXterm.write(new Uint8Array(e.data));
  mainXterm.onData(d => xtermWs.send(new TextEncoder().encode(d)));

  window.onresize = () => {{
    updateTerminalSizes();
    mainXtermFit.fit();
    let i = 0;
    while(i < terminals.length) {{
      terminals[i].fit.fit();
      i++;
    }}
  }};
}}, 100);
</script>
</body></html>
